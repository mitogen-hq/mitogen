# issue #1061: ensure remote temporary directory is recreated

- name: integration/context_service/remote_tmp.yml
  hosts: test-targets
  gather_facts: false
  tasks:
    - name: Exercise ansible_remote_tmp
      copy:
        dest: canary
        mode: u=rw,go=
        content: |
          Created by integration/context_service/remote_tmp.yml

    - debug:
        msg: ANSIBLE_REMOTE_TMP={{ lookup('env', 'ANSIBLE_REMOTE_TMP') }}

    - command:
        ls -l "{{ lookup('env', 'ANSIBLE_REMOTE_TMP') }}"
      changed_when: false
      register: out

    - debug:
        var: out

    - name: Delete ansible_remote_tmp
      raw: |
        rm -rf "{{ lookup('env', 'ANSIBLE_REMOTE_TMP') }}"

    - name: Do something else that requires ansible_remote_tmp
      file:
        path: canary
        state: absent
  tags:
    - issue_1061
    - remote_tmp
