- name: integration/package_managers/all.yml
  hosts: test-targets
  gather_facts: true
  # Most OS package managers need root. Homebrew refuses to run as root. This
  # approximates "pkg_mgr == homebrew" for the Linux & macOS runners in CI.
  become: "{{ inventory_hostname in (groups.linux | default([])) }}"
  vars:
    ansible_python_interpreter: auto
    package: rsync  # Chosen to exist in all tested distros/package managers
  tasks:
    - name: Switch to archived package repositories
      copy:
        dest: "{{ item.dest }}"
        content: "{{ item.content }}"
        mode: u=rw,go=r
      loop: "{{ pkg_repos_overrides }}"
      loop_control:
        label: "{{ item.dest }}"

    - name: Add signing keys
      copy:
        src: "{{ item.src }}"
        dest: "/etc/apt/trusted.gpg.d/{{ item.src | basename }}"
        mode: u=rw,go=r
      loop: "{{ pkg_repos_gpg_keys }}"

    - name: Update package index
      apt:
        update_cache: true
      when:
        - ansible_facts.pkg_mgr in ["apt"]

    - name: Test package module 1st call
      package:
        name: "{{ package }}"
        state: present

    - name: Test package module 2nd call
      package:
        name: "{{ package }}"
        state: present

    - name: Test dnf module 1st call
      dnf:
        name: "{{ package }}"
        state: present
      when:
        - ansible_facts.pkg_mgr == 'dnf'

    - name: Test dnf module 2nd call
      dnf:
        name: "{{ package }}"
        state: present
      when:
        - ansible_facts.pkg_mgr == 'dnf'

    - name: Test apt module 1st call
      apt:
        name: "{{ package }}"
        state: present
      when:
        - ansible_facts.pkg_mgr == 'apt'

    - name: Test apt module 2nd call
      apt:
        name: "{{ package }}"
        state: present
      when:
        - ansible_facts.pkg_mgr == 'apt'
