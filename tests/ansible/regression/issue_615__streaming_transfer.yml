# issue #615: 'fetch' with become: was internally using slurp.

- name: regression/issue_615_streaming_transfer.yml
  hosts: test-targets
  gather_facts: no
  # Without Mitogen this causes Ansible to use the slurp module, which is *slow*
  become: true
  vars:
    mitogen_ssh_compression: false
    file_path_controller: "/tmp/fetch-{{ inventory_hostname }}-512mb.txt"
    file_path_target: /tmp/mitogen-test-512mb.txt
    file_size: "{{ 512 * 2**20 }}"
  tasks:
    - include_tasks: _mitogen_only.yml
    - block:
        - name: Create test file on target
          script:
            cmd: generate_ascii_test_data.py "{{ file_size }}" "{{ file_path_target }}"
            executable: "{{ ansible_python_interpreter | default(ansible_facts.discovered_interpreter_python) }}"
            creates: "{{ file_path_target }}"
          register: target_file_task

        - debug:
            var: target_file_task

        - name: Fetch test file
          fetch:
            src: "{{ file_path_target }}"
            dest: "{{ file_path_controller }}"
            flat: true

        - name: Cleanup target
          file:
            path: "{{ file_path_target }}"
            state: absent

        - name: Cleanup controller
          file:
            path: "{{ file_path_controller }}"
            state: absent
          become: false
          delegate_to: localhost
  tags:
    - issue_615
    - mitogen_only
